<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TechGeek - Staff Portal</title>
    <link rel="stylesheet" href="../css/style.css">
    <style>
        /* Staff-specific styles */
        header { display: none; } /* Hides the standard header/nav */
        .staff-main {
            padding: 4rem 2rem;
            max-width: 800px;
            margin: 0 auto;
            min-height: 100vh;
        }
    </style>
</head>
<body>

    <main class="staff-main">
        <section style="grid-column: 1 / -1; background-color: #444444;">
            <h2>ðŸ”‘ Staff Portal: Live Community Poll Results</h2>
            <p>Results are fetched live from the external Google Sheet data source. **Refresh the page to update.**</p>
            <hr style="margin: 15px 0;">
            
            <h3 id="total-votes">Total Votes: Loading...</h3>
            
            <div id="results-container">
                <p class="loading-message">Fetching data from the external API...</p>
                </div>

            <p style="margin-top: 20px; font-style: italic; color: #aaa;">Data Source: SheetDB API (Client-Side Fetch)</p>
        </section>
        
        <section style="grid-column: 1 / -1; background-color: #555555;">
            <h2>Quick Links</h2>
            <ul>
                <li><a href="https://sheetdb.io/login" target="_blank">Go to SheetDB Dashboard</a></li>
                <li><a href="/">Return to Public Homepage</a></li>
            </ul>
        </section>
    </main>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // ** SheetDB API URL (READ-ONLY) **
            const API_URL = 'https://sheetdb.io/api/v1/tbavlx57c6jrr'; 
            
            // Expected poll options (must match values submitted to the Google Form)
            const options = ['GPU', 'RAM', 'CPU']; 
            
            const resultsContainer = document.getElementById('results-container');
            const totalVotesElement = document.getElementById('total-votes');

            async function fetchAndRenderPollResults() {
                try {
                    const response = await fetch(API_URL);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const data = await response.json();

                    // Step 1: Tally the Votes
                    const voteCounts = {};
                    options.forEach(opt => voteCounts[opt] = 0);
                    
                    data.forEach(row => {
                        // ** CRITICAL: Assumes column header in Google Sheet is named 'upgrade' **
                        const vote = row.upgrade; 
                        if (voteCounts.hasOwnProperty(vote)) {
                            voteCounts[vote]++;
                        }
                    });

                    const totalVotes = data.length;
                    totalVotesElement.textContent = `Total Votes: ${totalVotes}`;

                    // Step 2: Render the Results
                    let html = '';
                    
                    if (totalVotes === 0) {
                        html = '<p class="loading-message">No votes have been cast yet.</p>';
                    } else {
                        options.forEach(option => {
                            const count = voteCounts[option];
                            const percentage = totalVotes > 0 ? ((count / totalVotes) * 100).toFixed(1) : 0;

                            // Ensure the 'votes' text only shows when the bar is wide enough
                            const barText = percentage > 5 ? `${count} votes (${percentage}%)` : '';
                            
                            html += `
                                <div style="margin: 20px 0;">
                                    <h4 style="color: white; margin-bottom: 5px;">${option}</h4>
                                    <div class="vote-bar">
                                        <div class="vote-fill" style="width: ${percentage}%;">
                                            ${barText}
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                    }

                    resultsContainer.innerHTML = html;

                } catch (error) {
                    console.error('Error fetching poll data:', error);
                    totalVotesElement.textContent = 'Total Votes: ERROR';
                    resultsContainer.innerHTML = `<p class="loading-message" style="color: red;">Failed to load poll data. Check the SheetDB API URL and access settings.</p>`;
                }
            }

            fetchAndRenderPollResults();
        });
    </script>
</body>
</html>
